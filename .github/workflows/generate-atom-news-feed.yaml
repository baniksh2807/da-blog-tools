name: Generate Atom news feed

on:
  repository_dispatch:
    types:
      - resource-published
  schedule:
    # Fixed comment to match actual cron
    - cron: '*/15 * * * *'  # Every 15 minutes (WARNING: expensive!)
  pull_request:
    paths:
      - '.github/ci/**'
      - '.github/workflows/generate-atom-news-feed.yaml'
  workflow_dispatch: {}  # Fixed: Add empty object for proper parsing
  push:  # Added: Immediate trigger for testing
    branches: [main]
    paths:
      - '.github/ci/**'
      - '.github/workflows/generate-atom-news-feed.yaml'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Workflow info
      run: |
        echo "ğŸš€ Triggered by: ${{ github.event_name }}"
        echo "ğŸ“… Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”„ Run: #${{ github.run_number }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
    
    - uses: actions/checkout@v4
        
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Check CI directory structure
      run: |
        echo "ğŸ“ Checking CI directory structure..."
        ls -la ./.github/ci/
        echo ""
        echo "ğŸ“„ Package files:"
        ls -la ./.github/ci/package* || echo "No package files found"
        
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        # Removed cache config since package-lock.json doesn't exist
        
    - name: Install dependencies
      working-directory: ./.github/ci
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        # Check if package.json exists
        if [ -f "package.json" ]; then
          echo "âœ… package.json found"
          cat package.json
          echo ""
          echo "ğŸ”§ Installing with npm install (no lock file)..."
          npm install
        else
          echo "âŒ No package.json found, creating minimal one..."
          npm init -y
          npm install feed
        fi
        echo "âœ… Dependencies installed"
        echo "ğŸ“Š Installed packages:"
        npm list --depth=0 || echo "Could not list packages"

    - name: Generate Feeds
      working-directory: ./.github/ci
      run: |
        echo "ğŸš€ Starting feed generation..."
        node generate-news-feed.js
        echo "âœ… Feed generation completed"

    - name: List generated feeds
      run: |
        echo "=== ğŸ“‚ Generated Feed Files ==="
        find . -name "feed.xml" -type f | while read feed; do
          echo "ğŸ“„ Found feed: $feed"
          echo "   ğŸ“ Size: $(stat -f%z "$feed" 2>/dev/null || stat -c%s "$feed" 2>/dev/null) bytes"
          echo "   ğŸ“… Modified: $(stat -f%Sm "$feed" 2>/dev/null || stat -c%y "$feed" 2>/dev/null)"
          echo ""
        done

    - name: Verify feed content
      run: |
        echo "=== ğŸ” Feed Content Preview ==="
        find . -name "feed.xml" -type f | while read feed; do
          echo "=== Content of $feed ==="
          head -15 "$feed"
          echo ""
          echo "=== End of $feed ==="
          echo ""
        done

    - name: Check for changes
      id: changes
      run: |
        echo "=== ğŸ“Š Checking for file changes ==="
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Files have changed:"
          git status --short
          
          CHANGED_FEEDS=$(git status --porcelain | grep "feed.xml" | wc -l)
          echo "feed_count=$CHANGED_FEEDS" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Number of changed feeds: $CHANGED_FEEDS"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes detected"
          echo "feed_count=0" >> $GITHUB_OUTPUT
        fi

    - name: Show feed statistics
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "=== ğŸ“ˆ Feed Generation Statistics ==="
        echo "Total feeds generated: ${{ steps.changes.outputs.feed_count }}"
        
        echo ""
        echo "ğŸ“‚ Feed locations:"
        git status --porcelain | grep "feed.xml" | while read status file; do
          echo "   $status $file"
        done
        
        echo ""
        echo "ğŸ“ Feed sizes:"
        find . -name "feed.xml" -type f -exec ls -lh {} \;

    - name: Commit and push all feed changes
      if: steps.changes.outputs.changed == 'true'
      uses: stefanzweifel/git-auto-commit-action@v7
      with:
        file_pattern: '*/feed.xml **/*feed.xml **/*/feed.xml'
        commit_message: 'chore: update RSS feeds (${{ steps.changes.outputs.feed_count }} feeds) [skip ci]'
        commit_user_name: github-actions[bot]
        commit_user_email: github-actions[bot]@users.noreply.github.com

    - name: Post-commit summary
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "=== âœ… Commit Summary ==="
        echo "Successfully committed ${{ steps.changes.outputs.feed_count }} RSS feeds"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ“… Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        echo ""
        echo "ğŸ“„ Committed files:"
        git show --name-only --pretty="" HEAD | grep "feed.xml" | while read file; do
          echo "   âœ“ $file"
        done

    - name: Feed URLs for testing
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "=== ğŸŒ Feed URLs for Testing ==="
        BASE_URL="https://main--da-blog-tools--baniksh2807.aem.live"
        
        find . -name "feed.xml" -type f | while read feed; do
          FEED_PATH=$(echo "$feed" | sed 's|^\./||')
          FEED_URL="$BASE_URL/$FEED_PATH"
          echo "ğŸ”— $FEED_URL"
        done