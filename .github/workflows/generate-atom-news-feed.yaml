name: Generate Atom news feed

on:
  repository_dispatch:
    types:
      - resource-published
  schedule:
    - cron: '*/15 * * * *'
  pull_request:
    paths:
      - '.github/ci/**'
      - '.github/workflows/generate-atom-news-feed.yaml'
  workflow_dispatch: {}
  push:
    branches: [main]
    paths:
      - '.github/ci/**'
      - '.github/workflows/generate-atom-news-feed.yaml'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      working-directory: ./.github/ci
      run: npm install

    - name: Generate feeds
      working-directory: ./.github/ci
      run: node generate-news-feed.js

    - name: List generated feeds
      run: |
        find . -name "feed.xml" -type f | head -10 | while read feed; do
          echo "Feed: $feed ($(stat -c%s "$feed" 2>/dev/null || stat -f%z "$feed" 2>/dev/null) bytes)"
        done

    - name: Display feed content
      run: |
        find . -name "feed.xml" -type f | head -5 | while read feed; do
          echo "=== $feed ==="
          head -15 "$feed"
          echo ""
        done

    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          CHANGED_FEEDS=$(git status --porcelain | grep "feed.xml" | wc -l)
          echo "feed_count=$CHANGED_FEEDS" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "feed_count=0" >> $GITHUB_OUTPUT
        fi

    - name: Debug git status
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "=== Git Debug Info ==="
        echo "Current branch: $(git branch --show-current)"
        echo "Remote URL: $(git remote get-url origin)"
        echo "Git status:"
        git status
        echo "Files to add:"
        find . -name "feed.xml" -type f

    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        # Add files
        find . -name "feed.xml" -type f -print0 | xargs -0 git add
        
        # Check if anything is staged
        if git diff --cached --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # Commit
        git commit -m "chore: update RSS feeds (${{ steps.changes.outputs.feed_count }} feeds) [skip ci]"
        
        # Push with explicit branch
        git push origin HEAD:${{ github.ref_name }}